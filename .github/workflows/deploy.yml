name: Deploy from tag in main

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      
      - name: Fetch all branches
        run: git fetch --all --tags --prune

      - name: Check if tag is on main
        id: verify_tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          COMMIT=$(git rev-list -n 1 "$TAG")

          if git branch -r --contains "$COMMIT" | grep -q "origin/main"; then
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Cancel if not in main
        if: steps.verify_tag.outputs.ok != 'true'
        run: exit 1
        
      - name: Deploy to hosting via ssh
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.PATH }}
            set -e

            echo "ðŸš€ Deploying version: ${{ github.ref_name }} from main"

            /opt/php/8.2/bin/php artisan down || true
            git pull origin main --tags

            /opt/php/8.2/bin/php /var/www/u1229058/data/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            /opt/php/8.2/bin/php artisan package:discover --ansi

            /opt/php/8.2/bin/php artisan migrate --force
            /opt/php/8.2/bin/php artisan cache:clear
            /opt/php/8.2/bin/php artisan route:cache
            /opt/php/8.2/bin/php artisan config:cache
            /opt/php/8.2/bin/php artisan up

            /opt/php/8.2/bin/php artisan weather:fetch-and-send --deploy-info

            echo "âœ… Deployed successfully!"
