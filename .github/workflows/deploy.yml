name: Deploy from tag in main

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag is on main
        id: verify_tag
        shell: bash
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          COMMIT=$(git rev-list -n 1 "$TAG_NAME")
          BRANCHES=$(git branch -r --contains "$COMMIT")
          echo "ðŸ” Commit $COMMIT is in branches: $BRANCHES"
      
          if echo "$BRANCHES" | grep -q "origin/main"; then
            echo "âœ… Tag is on main"
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tag is not on main, cancelling"
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Cancel if not on main
        if: steps.verify_tag.outputs.ok != 'true'
        run: exit 1

      - name: Deploy to hosting via ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.PATH }}
            set -e

            echo "ðŸš€ Deploying version: ${{ github.ref_name }} from main"

            /opt/php/8.2/bin/php artisan down || true
            git pull origin main --tags

            /opt/php/8.2/bin/php /var/www/u1229058/data/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            /opt/php/8.2/bin/php artisan package:discover --ansi

            /opt/php/8.2/bin/php artisan migrate --force
            /opt/php/8.2/bin/php artisan cache:clear
            /opt/php/8.2/bin/php artisan route:cache
            /opt/php/8.2/bin/php artisan config:cache
            /opt/php/8.2/bin/php artisan up

            /opt/php/8.2/bin/php artisan weather:fetch-and-send --deploy-info

            echo "âœ… Deployed successfully!"
